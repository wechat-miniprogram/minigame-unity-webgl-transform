(()=>{"use strict";var t={28:(t,e,i)=>{var s=i(838),o=s.spawn,n=s.exec;function c(t,e,i){var s={};try{Object.keys(t).forEach((function(i){t[i].forEach((function(t){s[t]||(r(t,e),s[t]=1)})),s[i]||(r(i,e),s[i]=1)}))}catch(t){if(i)return i(t);throw t}if(i)return i()}function r(t,e){try{process.kill(parseInt(t,10),e)}catch(t){if("ESRCH"!==t.code)throw t}}function a(t,e,i,s,o){var n=s(t),c="";n.stdout.on("data",(function(t){t=t.toString("ascii"),c+=t})),n.on("close",(function(n){delete i[t],0==n?c.match(/\d+/g).forEach((function(n){n=parseInt(n,10),e[t].push(n),e[n]=[],i[n]=1,a(n,e,i,s,o)})):0==Object.keys(i).length&&o()}))}t.exports=function(t,e,i){if("function"==typeof e&&void 0===i&&(i=e,e=void 0),t=parseInt(t),Number.isNaN(t)){if(i)return i(new Error("pid must be a number"));throw new Error("pid must be a number")}var s={},r={};switch(s[t]=[],r[t]=1,process.platform){case"win32":n("taskkill /pid "+t+" /T /F",i);break;case"darwin":a(t,s,r,(function(t){return o("pgrep",["-P",t])}),(function(){c(s,e,i)}));break;default:a(t,s,r,(function(t){return o("ps",["-o","pid","--no-headers","--ppid",t])}),(function(){c(s,e,i)}))}}},838:t=>{t.exports=require("child_process")},936:t=>{t.exports=require("os")}},e={};function s(i){var o=e[i];if(void 0!==o)return o.exports;var n=e[i]={exports:{}};return t[i](n,n.exports,s),n.exports}s.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return s.d(e,{a:e}),e},s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{const t=s(936),e={MACOS:"Darwin"===t.type(),M1:t.cpus().some((t=>t.model.toLowerCase().indexOf("apple")>-1)),DS:function(){switch(process.platform){case"darwin":return"/";case"win32":return"\\"}return"/"}()},o=s(838).spawn,n=s(28),c=[1,2,5],r={4096:200,2048:80,1024:70,512:60,256:40};class a{execPath="";options=[];#t=30;#e=()=>{};#i=()=>{};constructor(t=2048){for(let e in r)if(t>=e)return void(this.#t=r[e]);this.#t=30}run(){return new Promise(((t,e)=>{this.#e=t,this.#i=e,this.#s()}))}#s(){this.refreshTimeout()?(this.#o=!0,this.child=o(this.execPath,this.options),this.child.stdout.on("data",(function(t){})),this.child.on("close",(t=>{clearTimeout(this.#n),this.#e()}))):this.#i()}#c=-1;#n=-1;#o=!1;refreshTimeout(){return this.#c++,!(this.#c>=c.length||(this.#n=setTimeout((()=>{this.retryProcess()}),c[this.#c]*this.#t*1e3),0))}retryProcess(){this.#o&&(n(this.child.pid),this.#o=!1),this.#s()}}const h=require("fs");var l=s.n(h);const u={ProgressMessage(t,e,i){console.log(`[PROGRESS]${t},${e},${i}`)},ConsoleMessage(t){console.log(`[LOG]${t}`)},ResponseMsg(t){console.log(`[DONE]${t}`)},RecordFile(t){console.log(`[RECORDFILE]${t}`)}},f=e.MACOS?e.M1?"astcenc-neon":"astcenc-avx2":"astcenc-sse4.1.exe";class g extends a{#r="";#a="";#h="8x8";#l="-cs";constructor(t,i,s,o="8x8",n=2048,c="Gamma"){super(n),this.execPath=`${t}${e.DS}${f}`,this.#r=i,this.#a=s,this.#h=o,this.#l="Linear"==c?"-cl":"-cs"}async convert(){try{await l().promises.access(this.#a),l().rmSync(this.#a)}catch(t){}const t=this.#a+".astc";this.options=[this.#l,this.#r,t,this.#h,"-medium"],await this.run();try{l().renameSync(t,this.#a)}catch(t){throw u.ConsoleMessage(`【ASTC - convert】#104 原 [${this.#r}] 资源 ASTC 格式生成失败！`),`【ASTC - convert】#104 原 [${this.#r}] 资源 ASTC 格式生成失败！`}}}const d=e.MACOS?"PVRTexToolCLI":"PVRTexToolCLI.exe";class p extends a{#r="";#a="";#l="";constructor(t,i,s,o=2048,n="Gamma"){super(o),this.execPath=`${t}${e.DS}${d}`,this.#r=i,this.#a=s,this.#l="Linear"==n?"lRGB":"sRGB"}async convert(){try{await l().promises.access(this.#a),l().rmSync(this.#a)}catch(t){}const t=this.#a+".dds";this.options=["-i",this.#r,"-o",t,"-f",`BC3,UBN,${this.#l}`],await this.run();try{l().renameSync(t,this.#a)}catch(t){throw u.ConsoleMessage(`【DXT - convert】#106 原 [${this.#r}] 资源 DXT 格式生成失败！`),`【DXT - convert】#106 原 [${this.#r}] 资源 DXT 格式生成失败！`}}}const S=new class{#u;#f;#g;#d=!1;#p=[];constructor(){this.log("Wechat-assets-text-convert-tools Launch")}SetLogRoot(t){let i=new Date;const s=1e3+parseInt(8999*Math.random()),o=`WXLOGJS-${i.getHours()}-${i.getMinutes()}-${i.getSeconds()}-${s}.log`;let n=i.getMonth()+1;n<10&&(n="0"+n);let c=i.getDate();c<10&&(c="0"+c);const r=`${t}${e.DS}log${e.DS}${i.getFullYear()}${n}${c}`,a=`${r}${e.DS}${o}`;return this.#g=r,this.#u=a,this.#f=o,l().existsSync(this.#g)||l().mkdirSync(this.#g),l().existsSync(this.#u)||l().writeFileSync(this.#u,"",{encoding:"utf-8"}),this.#d=!0,this.#S(),this.#u}log(){if(!arguments||0==arguments.length)return;const t=arguments[0];let e=[];for(let t=1;t<arguments.length;t++)e.push(arguments[t]);let i={title:t,args:e,timestamp:(new Date).getTime()};const s=JSON.stringify(i)+",";this.#$(s)}#m(){let t=new Date;t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()}#$(t){this.#d?l().appendFileSync(this.#u,t,{encoding:"utf-8"}):this.#p.push(t)}#S(){for(;;){let t=this.#p.shift();if(!t)return;this.#$(t)}}},$=e.MACOS?"PVRTexToolCLI":"PVRTexToolCLI.exe";class m extends a{#r="";#a="";#l="";constructor(t,i,s,o=2048,n="Gamma"){super(o),this.execPath=`${t}${e.DS}${$}`,this.#r=i,this.#a=s,this.#l="Linear"==n?"lRGB":"sRGB"}async convert(){S.log("etc2 convert - 0",this.#a);try{await l().promises.access(this.#a),l().rmSync(this.#a)}catch(t){}const t=this.#a+".pvr";S.log("etc2 convert - 1",this.#a,t),this.options=["-i",this.#r,"-o",t,"-f",`ETC2_RGBA,UBN,${this.#l}`],await this.run(),S.log("etc2 convert - 2",this.#a);for(let e=0;e<10;e++){if(S.log("etc2 convert - 3",e,this.#a),l().existsSync(t)){S.log("etc2 convert - 4",e,this.#a);try{l().renameSync(t,this.#a);let e=l().readFileSync(this.#a);l().writeFileSync(this.#a,e.slice(52))}catch(t){throw S.log("etc2 convert - 5",e,this.#a,JSON.stringify(t)),u.ConsoleMessage(`【ETC2 - convert】#107 原 [${this.#r}] 资源 ETC2 格式生成失败！`),`【ETC2 - convert】#107 原 [${this.#r}] 资源 ETC2 格式生成失败！`}return}await this.sleep(1e3)}throw S.log("etc2 convert - 6",i,this.#a),u.ConsoleMessage(`【ETC2 - convert】#108 原 [${this.#r}] 资源 ETC2 格式生成失败！`),`【ETC2 - convert】#108 原 [${this.#r}] 资源 ETC2 格式生成失败！`}sleep(t){return t<=0&&(t=1),new Promise((e=>{setTimeout((()=>{e()}),t)}))}}const P=e.MACOS?"pngquant":"pngquant.exe";class x extends a{#r="";#a="";constructor(t,i,s,o=2048,n="Gamma"){super(o),this.execPath=`${t}${e.DS}${P}`,this.#r=i,this.#a=s}async convert(){this.options=[this.#r,"-o",this.#r,"-f"],await this.run()}}class w{#u;#g;#P={};constructor(t){this.#g=t,this.#u=`${t}${e.DS}JSDEALSFILERECORD.json`,this.#x(),this.#w()}#x(){l().existsSync(this.#g)||l().mkdirSync(this.#g),l().existsSync(this.#u)||l().writeFileSync(this.#u,"",{encoding:"utf-8"})}#w(){const t=l().readFileSync(this.#u,{encoding:"utf-8"});this.#P=""==t?{timestamp:0,files:[]}:JSON.parse(t)}save(){this.#P.timestamp=(new Date).getTime();const t=JSON.stringify(this.#P);l().existsSync(this.#u)&&l().rmSync(this.#u),l().writeFileSync(this.#u,t,{encoding:"utf-8"})}getInfo(t){for(let e of this.#P.files)if(e.originPngPath==t)return e;return null}setInfo(t){let e=!1,i=0;for(;i<this.#P.files.length;i++)if(this.#P.files[i].originPngPath==t.originPngPath){e=!0;break}e?this.#P.files[i]=t:this.#P.files.push(t)}defaultStruct(t,e,i){return{name:e.name,width:e.width,height:e.height,astc:!1,dxt:!1,etc:!1,pngmin:!1,lpng:!1,lpngmin:!1,originPngPath:t,colorSpace:i}}}const y=s(936).cpus().length,C=e.DS,D=new class{constructor(t){for(let e of t)this.#y(e)}#C={};getConfig(t){return this.#C[t]}setConfig(t,e){this.#C[t]=e}#y(t=""){let e=t.indexOf("=");if(e<=0||e>=t.length-1)return;let i=t.substring(0,e),s=t.substring(e+1,t.length);this.#C[i]=s}printOptions(){console.log("<-------------输入配置字典 Start-------------\x3e");for(let t in this.#C)console.log(`Key:${t} - Value:${this.#C[t]}`);console.log("<-------------输入配置字典 End-------------\x3e")}}(process.argv);new class{#D;#v=y;#p=[];#T=!1;#l="Gamma";#R=0;#O="";#M=!1;#b=0;#k;#F=0;constructor(t){this.#D=t}async launch(){this.#F=0,this.#E(),await this.#w(),this.#I=!1;for(let t=0;t<this.#v;t++)this.#N()}#E(){const t=this.#D.getConfig("-dataDir");if(!t)throw u.ConsoleMessage("【WXTools - convert】#201 缺少必要配置参数 -dataDir"),{code:201,errmsg:"缺少必要配置参数 -dataDir"};const e=S.SetLogRoot(t);u.RecordFile(e),this.#k=new w(t);const i=this.#D.getConfig("-config");if(!i)throw u.ConsoleMessage("【WXTools - convert】#201 缺少必要配置参数 -config"),{code:201,errmsg:"缺少必要配置参数 -config"};if(!l().existsSync(i))throw u.ConsoleMessage(`【WXTools - convert】#202 参数配置 -config [${i}] 指向无效`),{code:202,errmsg:`参数配置 -config [${i}] 指向无效`};if(!this.#D.getConfig("-outDir"))throw u.ConsoleMessage("【WXTools - convert】#203 缺少必要配置参数 -outDir"),{code:203,errmsg:"缺少必要配置参数 -outDir"};const s=this.#D.getConfig("-force");s&&(this.#M="true"==s);const o=["Gamma","Linear"],n=this.#D.getConfig("-colorSpace");n||(n="Gamma");let c=!1;for(let t of o)if(t==n){c=!0;break}if(!c)throw u.ConsoleMessage(`【WXTools - convert】#206 参数配置 -colorSpace [${n}] 赋值不合法`),{code:206,errmsg:`参数配置 -colorSpace [${n}] 赋值不合法`};this.#l=n;const r=this.#D.getConfig("-execRoot");if(!r)throw u.ConsoleMessage("【WXTools - convert】#204 缺少必要配置参数 -execRoot"),{code:204,errmsg:"缺少必要配置参数 -execRoot"};const a=["astcenc-avx2","astcenc-avx2.exe","astcenc-neon","astcenc-sse4.1.exe","pngquant","pngquant.exe","PVRTexToolCLI","PVRTexToolCLI.exe"];for(let t of a)if(!l().existsSync(`${r}${C}${t}`))throw u.ConsoleMessage(`【WXTools - convert】#205 参数配置 -execRoot [${r}] 缺少必要文件 [${t}]`),{code:204,errmsg:`参数配置 -execRoot [${r}] 缺少必要文件 [${t}]`};this.#O=r;const h=this.#D.getConfig("-type");this.#T=!(!h||"ASTC"!=h)}async#w(){const t=l().readFileSync(this.#D.getConfig("-config"),{encoding:"utf-8"}),e=JSON.parse(t),i=this.#D.getConfig("-outDir");for(let t of e.files)for(let e of t.textures){let t=decodeURIComponent(e.name),s=!1;for(let i of this.#p)if(i.name==t&&i.width==e.width){s=!0;break}if(s)continue;const o=`${i}${C}png${C}${e.width}${C}${t}.png`;if(!l().existsSync(o))continue;let n={name:t,width:e.width,height:e.height,astc:null==e.astc?"8x8":e.astc,limittype:e.limittype,path:`${i}${C}png${C}${e.width}${C}${t}.png`};l().existsSync(n.path)&&this.#p.push(n)}this.#R=this.#p.length;const s=`${i}${C}`;if(l().existsSync(`${s}astc`)||(this.#L=!0),l().existsSync(`${s}dds`)||(this.#A=!0),l().existsSync(`${s}etc2`)||(this.#q=!0),!this.#T&&!this.#M&&!this.#q&&this.#R>0){let t=null;for(let e of this.#p){let i=this.#k.getInfo(e.path);if(i&&i.etc){t=e;break}}if(!t)return;const e=t.path;let i=`${this.#D.getConfig("-outDir")}${C}etc2${C}${t.width}${C}`,s=`${i}${t.name}.txt`;if(!l().existsSync(s))return;let o=`${i}${t.name}.temp.txt`;this.#G(i);try{const i=new m(this.#O,e,o,t.width,this.#l);await i.convert();const n=l().readFileSync(s),c=l().readFileSync(o);let r=!0;for(let t=0;t<n.length;t++)if(t>=c.length||n[t]!=c[t]){r=!1;break}r||(this.#q=!0)}catch{}l().existsSync(o)&&l().rmSync(o)}}#L=!1;#A=!1;#q=!1;async#N(){for(;;){const t=this.#p.shift();if(!t)break;(new Date).getTime();const e=t.path,i=this.#D.getConfig("-outDir");let s=this.#k.getInfo(e);s||(s=this.#k.defaultStruct(e,t,this.#l)),this.#_(e);let o="",n="";if(this.#M||this.#L||!s.astc||s.colorSpace!=this.#l){(new Date).getTime(),o=`${i}${C}astc${C}${t.width}${C}`,n=`${o}${t.name}.txt`,this.#G(o);try{const i=new g(this.#O,e,n,t.astc,t.width,this.#l);await i.convert(),s.astc=!0}catch(t){this.#F++,u.ConsoleMessage(`Output path:[${n}] is failed.`),s.astc=!1}}if(this.#T)this.#k.setInfo(s);else{if(this.#M||this.#A||!s.dxt||s.colorSpace!=this.#l){(new Date).getTime(),o=`${i}${C}dds${C}${t.width}${C}`,n=`${o}${t.name}.txt`,this.#G(o);try{const i=new p(this.#O,e,n,t.width,this.#l);await i.convert(),s.dxt=!0}catch(t){this.#F++,u.ConsoleMessage(`Output path:[${n}] is failed.`),s.dxt=!1}}if(this.#M||this.#q||!s.etc||s.colorSpace!=this.#l){(new Date).getTime(),o=`${i}${C}etc2${C}${t.width}${C}`,n=`${o}${t.name}.txt`,this.#G(o);try{const i=new m(this.#O,e,n,t.width,this.#l);await i.convert(),s.etc=!0}catch(t){this.#F++,u.ConsoleMessage(`Output path:[${n}] is failed.`),s.etc=!1}}if(this.#M||!s.pngmin){(new Date).getTime();try{const i=new x(this.#O,e,e,t.width,this.#l);await i.convert(),s.pngmin=!0}catch(t){this.#F++,u.ConsoleMessage(`Output path:[${n}] is failed.`),s.pngmin=!1}}if("Linear"==this.#l&&(this.#M||!s.lpngmin))try{o=`${i}${C}lpng${C}${t.width}${C}`,lpngPath=`${o}${t.name}.png`;const e=new x(this.#O,lpngPath,lpngPath,t.width,this.#l);await e.convert(),s.lpngmin=!0}catch(t){this.#F++,u.ConsoleMessage(`Output path:[${n}] is failed.`),s.lpngmin=!1}this.#k.setInfo(s)}}this.#b++,this.#X()}#_(t){u.ProgressMessage(this.#R-this.#p.length,this.#R,t)}#G(t){l().existsSync(t)||l().mkdirSync(t,{recursive:!0})}#W(){return new Promise(((t,e)=>{setTimeout((()=>{t()}),100)}))}#I=!1;#X(){this.#b==this.#v&&(this.#I=!0,this.#k.save(),u.ResponseMsg("All Asset Textures have been converted! (Failed count: "+this.#F+")"))}}(D).launch()})()})();